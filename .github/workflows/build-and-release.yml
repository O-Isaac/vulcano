name: Build & Release Java 25

on:
  push:
    branches: [ "main", "master" ]

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
    # 1. Checkout (con fetch-depth: 0 para tener historial de git para el log)
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0 

    # 2. Setup Java 25
    - name: Set up JDK 25
      uses: actions/setup-java@v4
      with:
        java-version: '25'
        distribution: 'temurin'
        cache: 'maven'

    # 3. Build del .jar
    - name: Grant execute permission for mvnw
      run: chmod +x mvnw

    - name: Build with Maven
      run: ./mvnw clean package -DskipTests

    # 4. Generar Notas de Release "Bonitas"
    # Este paso crea un archivo Markdown con badges, fecha y lista de commits.
    - name: Generate Release Notes
      id: release_notes
      run: |
        DATE=$(date +'%Y-%m-%d')
        
        echo "## üöÄ Despliegue Autom√°tico - $DATE" > release_notes.md
        echo "" >> release_notes.md
        echo "![Java 25](https://img.shields.io/badge/Java-25-orange?logo=openjdk&style=flat-square) ![Build Status](https://img.shields.io/badge/Build-Passing-success?style=flat-square)" >> release_notes.md
        echo "" >> release_notes.md
        echo "### üì¶ Contenido de la Release" >> release_notes.md
        echo "Esta versi√≥n ha sido compilada y empaquetada autom√°ticamente desde la rama principal." >> release_notes.md
        echo "" >> release_notes.md
        echo "### üõ†Ô∏è √öltimos Cambios" >> release_notes.md
        # Muestra los √∫ltimos 5 commits con formato de lista, hash corto y autor
        git log --pretty=format:"* \`%h\` - %s (**%an**)" -n 5 >> release_notes.md
        echo "" >> release_notes.md
        echo "---" >> release_notes.md
        echo "üìå _Descarga el archivo .jar abajo para ejecutar el servidor._" >> release_notes.md

    # 5. Publicar Release usando el archivo generado
    - name: Update 'latest' Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: latest
        name: "v25-release-${{ github.run_number }}" # Nombre din√°mico con n√∫mero de ejecuci√≥n
        body_path: release_notes.md  # Usamos el archivo que creamos arriba
        files: target/*.jar
        draft: false
        prerelease: false
        make_latest: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}